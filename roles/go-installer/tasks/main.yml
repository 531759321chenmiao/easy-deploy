- name: Checkout golang version
  command: '{{ go_bin_dir }}/go version | grep {{ go_version }}'
  register: go_version_detect
  ignore_errors: true

- name: Clone golang source
  ansible.builtin.git:
    repo: 'https://github.com/golang/go.git'
    dest: '{{ go_source_dir }}'
    version: 'go{{ go_version }}'
    force: true
  when: go_version_detect.failed

- name: Build golang source
  command: './all.bash'
  args:
    chdir: '{{ go_source_dir }}/src'
  async: 3600
  poll: 0
  register: go_builder
  when: go_version_detect.failed

- name: Check go build progress
  async_status:
    jid: '{{ go_builder.ansible_job_id }}'
  register: go_builder_progress
  until: go_builder_progress.finished
  retries: 10000
  delay: 5
  when: go_version_detect.failed

- name: Create go bin directory
  file:
    path: '{{ go_bin_dir }}'
    state: directory
    recurse: yes

- name: Move go bin to target
  copy:
    src: '{{ go_source_dir }}/bin/go'
    dest: '{{ go_bin_dir }}/go'
  when: go_version_detect.failed

- name: Move gofmt bin to target
  copy:
    src: '{{ go_source_dir }}/bin/gofmt'
    dest: '{{ go_bin_dir }}/gofmt'
  when: go_version_detect.failed
